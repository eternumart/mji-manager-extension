import { apiConfig } from "../apiConfig";
import { saveToCache } from "../components/Extention/utils/saveToCache";

console.log("DOMEvaluator.ts loaded");

export let baseUrl = `${apiConfig.address.protocol}${apiConfig.address.ip}`; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±—Ä–∞–Ω —Å–µ—Ä–≤–µ—Ä Prod
let isLoading = false;
const loadingFlags = new Map<string, boolean>();

chrome.runtime.onMessage.addListener(async (request, sender, sendResponse) => {
	switch (request.contentScriptQuery) {
		case "activation-request": {
			if (!request.data.login || !request.data.password) {
				return;
			}
			activation(request);
			break;
		}
		case "logIn-request": {
			if (!request.data.login || !request.data.password) {
				return;
			}

			console.log("3!üîπ logIn-request –ø–æ–ª—É—á–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...");

			login(request)
				.then((response) => {
					console.log("5! ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º logIn-response...");
					chrome.runtime.sendMessage({
						contentScriptQuery: "logIn-response",
						data: [response, request.data.login],
					});
				})
				.catch((error) => {
					console.error("5!‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", error);
					chrome.runtime.sendMessage({
						contentScriptQuery: "logIn-response",
						data: { success: false, error: error.message },
					});
				});

			return;
		}
		case "setUsid-request": {
			setUsid(request);
			break;
		}
		case "savefio-request": {
			saveFio(request);
			console.log("savefio-request");
			break;
		}
		case "appData-request": {
			await appData(request);
			break;
		}
		case "checkusid-request": {
			checkUsid(request);
			break;
		}
		case "enviromentSwitch-request": {
			console.log(`üõ† –ó–∞–ø—Ä–æ—Å—ã –ø–æ–π–¥—É—Ç –Ω–∞ ${request.enviroment} —Å–µ—Ä–≤–µ—Ä.`);
			baseUrl = request.baseUrl;
			checkResponseFromServer(request);
			break;
		}
		case "app-loaded-response": {
			baseUrl = request.baseUrl;
			break;
		}
		case "enviroment-check-request": {
			console.log("enviroment-check-request");
			getCurrentEnviroment();
			break;
		}
		case "logOut-request": {
			console.log("üî¥ –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã—Ö–æ–¥");

			chrome.storage.local.clear(() => {
				console.log("‚úÖ –ö–µ—à –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω.");
			});

			sendResponse({ success: true });
			return true;
		}
	}
});

async function fetchWithRetryAndCache(
	url: string,
	options: RequestInit,
	retries: number = 1, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑
	useCache: boolean = false
): Promise<any> {
	if (loadingFlags.get(url)) {
		console.log("‚è±Ô∏è –ó–∞–ø—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:", url);
		return;
	}

	loadingFlags.set(url, true);
	isLoading = true;

	chrome.runtime.sendMessage({
		contentScriptQuery: "loader-state-response",
		isLoading: isLoading,
	});

	// üöÄ –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å (–¥–ª—è `login` –∏ `appData` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `retries = 5`)
	for (let i = 0; i < retries; i++) {
		try {
			console.info(`‚è≥ –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É ‚Ññ${i + 1} –ø–æ URL ${url}`);
			const response = await fetch(url, options);
			if (!response.ok) {
				chrome.runtime.sendMessage({
					contentScriptQuery: "Error-response",
					error: "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°—Ç–∞—Ç—É—Å: ${response.status}",
				});
			}
			const data = await response.json();

			loadingFlags.set(url, false);
			isLoading = false;

			chrome.runtime.sendMessage({
				contentScriptQuery: "loader-state-response",
				isLoading: isLoading,
			});

			if (retries === 3) {
				console.log("4! üì¶ –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
			}
			if (retries === 5) {
				console.log("9! üì¶ –°–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
			}
			return data;
		} catch (error) {
			chrome.runtime.sendMessage({
				contentScriptQuery: "Error-response",
				error: `‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ #${i + 1} –Ω–µ —É–¥–∞–ª–∞—Å—å: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.`,
			});
			if (i === retries - 1) {
				if (useCache) {
					const cachedData = await new Promise((resolve) => {
						chrome.storage.local.get([url], (result) => {
							resolve(result[url] || null);
						});
					});

					if (cachedData) {
						loadingFlags.set(url, false);
						isLoading = false;
						chrome.runtime.sendMessage({
							contentScriptQuery: "loader-state-response",
							isLoading: isLoading,
						});

						chrome.runtime.sendMessage({
							contentScriptQuery: "Error-response",
							error: "‚ö†Ô∏è –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
						});
						return cachedData;
					}
					chrome.runtime.sendMessage({
						contentScriptQuery: "Error-response",
						error: "‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å. –î–∞–Ω–Ω—ã–µ –≤ –∫–µ—à–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.",
					});
				}
				chrome.runtime.sendMessage({
					contentScriptQuery: "Error-response",
					error: "‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å.",
				});
			}
		}
	}
}

async function getCurrentEnviroment() {
	chrome.runtime.sendMessage({
		contentScriptQuery: "enviroment-check-response",
		enviroment: baseUrl,
	});
}

async function checkResponseFromServer(request: any) {
	console.log("‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ DOMEvaluator.ts");
	try {
		const url = `${baseUrl}${apiConfig.routes.api.checResponseFromServer}`;

		// –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–ª–∞–≥–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏
		await fetchWithRetryAndCache(url, {
			method: "GET",
			headers: { "Content-Type": "application/json" },
		}).then((res) => {
			console.log(`üü¢ –°–µ—Ä–≤–µ—Ä ${request.enviroment} –¥–æ—Å—Ç—É–ø–µ–Ω`);
			baseUrl = request.baseUrl;
		});
	} catch (error) {
		console.error(`üî¥ –°–µ—Ä–≤–µ—Ä ${request.enviroment} –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω`, error);
	}
}

async function activation(request: any) {
	console.log("–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è DOMEvaluator.ts");
	const url = `${baseUrl}${apiConfig.routes.api.activation}`;
	try {
		const data = await fetchWithRetryAndCache(url, {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ data: request.data }),
		});
		chrome.runtime.sendMessage({ data, contentScriptQuery: "activation-response" });
	} catch (error) {
		chrome.runtime.sendMessage({
			contentScriptQuery: "Error-response",
			error: error,
			flow: "activation",
		});
	}
}

async function login(request: any) {
	const url = `${baseUrl}${apiConfig.routes.api.login}`;

	try {
		const data = await fetchWithRetryAndCache(
			url,
			{
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ data: request.data }),
			},
			3, // 3 –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É
			true
		);

		return data;
	} catch (error) {
		chrome.runtime.sendMessage({
			contentScriptQuery: "Error-response",
			error: error,
			flow: "logIn",
		});
		return { success: false, error: error };
	}
}

async function saveFio(request: any) {
	const url = `${baseUrl}${apiConfig.routes.api.saveFio}`;
	try {
		const data = await fetchWithRetryAndCache(url, {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ data: request.data }),
		});
		chrome.runtime.sendMessage({ data, contentScriptQuery: "savefio-response" });
	} catch (error) {
		chrome.runtime.sendMessage({
			contentScriptQuery: "Error-response",
			error: error,
			flow: "savefio",
		});
	}
}

async function appData(request: any) {
	console.log("8! ‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.");
	const url = `${baseUrl}${apiConfig.routes.api.getAppData}`;

	try {
		const data = await fetchWithRetryAndCache(
			url,
			{
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ data: request.data }),
			},
			5, // 5 –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É
			true
		);
		console.log("10! ‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à...");
		saveToCache(baseUrl, data);
		chrome.runtime.sendMessage({ data, contentScriptQuery: "appData-response" });
	} catch (error) {
		console.log("10.1! ‚ùå –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –∫–µ—à–∞...");
		chrome.storage.local.get(baseUrl, (result) => {
			chrome.runtime.sendMessage({
				contentScriptQuery: "appData-response",
				data: result[baseUrl],
			});
		});
		chrome.runtime.sendMessage({
			contentScriptQuery: "Error-response",
			error: error,
			flow: "appData",
		});
	}
}

async function setUsid(request: any) {
	fetch(`${request.url}`, {
		method: "POST",
		headers: {
			"Content-Type": "application/json;charset=utf-8",
		},
		body: JSON.stringify({ data: request.data }),
	})
		.then(checkResponse)
		.then((res) => {
			chrome.runtime.sendMessage(res);
		});
	return true;
}

async function checkUsid(request: any) {
	await fetch(`${request.url}`, {
		method: "POST",
		headers: {
			"Content-Type": "application/json;charset=utf-8",
		},
		body: JSON.stringify({ data: request.data }),
	})
		.then(checkResponse)
		.then((res) => {
			chrome.runtime.sendMessage(res);
		});
}

function checkResponse(res: any) {
	if (res.ok) {
		return res.json();
	}
	return Promise.reject(res);
}

export {};
